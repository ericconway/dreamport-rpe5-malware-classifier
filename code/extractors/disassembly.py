import collections
import re
import subprocess
import zlib

__version__ = '0.1'
__enabled__ = True

NGRAM_LEN = 5
DECIMATION = 20

# Choice of disassembler:
#    objdump is over 20x faster
#    radare2 is more accurate
DISASSEMBLER = 'radare2'  # 'objdump'


def run(filepath='', fileinfo=None, **kwargs):
    print("%s.run(%s, %s, %s)"%(__name__, filepath, fileinfo, kwargs))

    assembly = []

    if DISASSEMBLER == 'objdump':
        cmd = ['objdump', '--disassemble', filepath]
    elif DISASSEMBLER == 'radare2':
        cmd = [
            'r2',  # radare2
            '-A',  # Analyze all (aaa command)
            '-q',  # quiet, don't ask questions and quit when done
            '-c',  # execute following command
            'e scr.color=0;pi @@ *func*;pi @@ *sub*;pi @@ *fcn*',
            # set screen colors off, print instructions for all functions/subroutines
            filepath,
        ]

    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE)
    for line in proc.stdout.readlines():

        # general cleanup
        line = line.decode('utf-8', errors='replace').strip()

        if DISASSEMBLER == 'objdump':
            tokens = line.split('\t')
            if len(tokens) < 3:
                continue

            # remove address and bytes, keep mnemonic and args
            line = ' '.join(tokens[2:]).strip()

            # remove numbers (addresses and offsets are too fragile and position dependent)
            line = re.sub('0x[a-f0-9]*', '', line)
            line = re.sub('[0-9]*', '', line)

        elif DISASSEMBLER == 'radare2':
            line = re.sub('0x[a-f0-9]*', '', line)

        # skip nops
        if line.lower().startswith('nop'):
            continue

        assembly.append(line)

    ngrams = collections.Counter()
    for i in range(len(assembly)-NGRAM_LEN):
        ng = ';'.join(assembly[i:i+NGRAM_LEN])

        # decimate, don't save all ngrams
        if zlib.crc32(ng.encode('utf-8')) % DECIMATION == 0:
            ngrams[ng] += 1

    return ngrams
