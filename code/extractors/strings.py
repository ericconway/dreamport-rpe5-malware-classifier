import collections
import re
import sys
import time

__version__ = '0.1'
__enabled__ = True

MIN_STR_LEN = 6
TIMEOUT = 60*2

SPECIAL_STRING_REGEXS = [
    re.compile('[0-9a-zA-Z]{1,32}(%s[0-9a-zA-Z]{1,32}){1,32}' % separator) for separator in ['\\.', '\\', '/', '-', ':']
    # examples: www.thing.com, YYYY-MM-DD, NN:NN:NN, path/to/somewhere
]


class RunTimeout(Exception):
    pass


def run(filepath='', fileinfo=None, **kwargs):
    start_time = time.time()
    with open(filepath, 'rb') as f:
        content = f.read()

    strings = collections.Counter()
    words = collections.Counter()
    specials = collections.Counter()
    try:
        for st in re.finditer(b'[\x20-\x7e]{%d,}' % MIN_STR_LEN, content):
            st = st.group(0).decode('utf-8', errors='replace')

            if time.time() - start_time > TIMEOUT:
                raise RunTimeout('regex')

            # split long lines of minified text
            st = st.replace('><', '>;<')  # so we split minified html
            for s in st.split(';'):  # so we split minified javascript
                s = s.strip()  # so we aren't thrown by indentation
                if len(s) >= MIN_STR_LEN:
                    strings[s] += 1
                if time.time() - start_time > TIMEOUT:
                    raise RunTimeout('strings')

            for wd in re.finditer('[a-zA-Z]{%d,}' % MIN_STR_LEN, st):
                wd = wd.group(0).lower()
                words['word: '+wd] += 1
                if time.time() - start_time > TIMEOUT:
                    raise RunTimeout('words')

            for regex in SPECIAL_STRING_REGEXS:
                for m in regex.finditer(st):
                    specials['special: '+m.group(0)] += 1
                    if time.time() - start_time > TIMEOUT:
                        raise RunTimeout('specials')

    except RunTimeout as e:
        print('    WARNING: Timeout expired for %s.run("%s") #%s' % (__name__, filepath, str(e)))

    features = strings + words + specials
    print("    %s produced %d features in %0.1f seconds" % (__name__, len(features), time.time()-start_time))
    return features


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print('Usage: %s filepath' % sys.argv[0])
        exit(-1)
    features = run(sys.argv[1])
    for f in features:
        print(f)
